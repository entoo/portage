https://lists.gnu.org/archive/html/bug-bash/2014-06/msg00070.html

--- readline-6.3/misc.c
+++ readline-6.3/misc.c
@@ -462,13 +462,13 @@
 	  /* Set up rl_line_buffer and other variables from history entry */
 	  rl_replace_from_history (entry, 0);	/* entry->line is now current */
 	  /* Undo all changes to this history entry */
+	  entry->data = 0;
 	  while (rl_undo_list)
 	    rl_do_undo ();
 	  /* And copy the reverted line back to the history entry, preserving
 	     the timestamp. */
 	  FREE (entry->line);
 	  entry->line = savestring (rl_line_buffer);
-	  entry->data = 0;
 	}
       entry = previous_history ();
     }
